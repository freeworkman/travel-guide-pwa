<!DOCTYPE html>
<html lang="zh-TW" style="height: 100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å…¨çƒæ—…éŠ AI åš®å°</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/826/826070.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- LZString å£“ç¸®åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <!-- Chart.js for Cost Analysis -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- iOS Critical Fixes --- */
        :root { --app-height: 100dvh; }
        html { height: 100%; width: 100%; overflow: hidden; }
        body { height: var(--app-height); width: 100%; margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #0ea5e9; display: flex; flex-direction: column; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        input, textarea, select { font-size: 16px !important; } 
        header, nav { flex-shrink: 0; z-index: 50; } 
        main { flex: 1; position: relative; overflow: hidden; background-color: #f8fafc; display: flex; flex-direction: row; }
        
        .panel-container { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        
        @media (max-width: 767px) { 
            .mobile-tab-content { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 10; background-color: #f8fafc; display: none; } 
            .mobile-tab-content.active { display: flex !important; } 
        }
        @media (min-width: 768px) { 
            .mobile-tab-content { position: relative; display: flex !important; z-index: auto; } 
        }
        
        #contentList, #historyList, #weatherList { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
        #mapPanel { flex-direction: column; }
        #map { flex-grow: 1; min-height: 0; width: 100%; z-index: 0; background-color: #e2e8f0; }
        
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #0ea5e9; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; } 
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        .custom-div-icon { background: transparent; border: none; }
        .marker-pin { width: 30px; height: 30px; border-radius: 50% 50% 50% 0; background: #0ea5e9; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -15px 0 0 -15px; box-shadow: 0 3px 5px rgba(0,0,0,0.3); border: 2px solid white; transition: all 0.2s; }
        .marker-pin::after { content: ''; width: 14px; height: 14px; margin: 6px 0 0 6px; background: #fff; position: absolute; border-radius: 50%; }
        .custom-div-icon i { position: absolute; width: 22px; font-size: 14px; left: 0; right: 0; margin: 8px auto; text-align: center; color: #0ea5e9; z-index: 10; }
        .marker-active .marker-pin { background: #ea580c; transform: scale(1.2) rotate(-45deg); z-index: 50; }
        .marker-active i { color: #ea580c; }

        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Numbered Marker Style */
        .number-icon {
            background-color: #0ea5e9;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
            transition: transform 0.2s;
        }
        .number-icon:active, .marker-active .number-icon {
            background-color: #ea580c;
            transform: scale(1.2);
            z-index: 100 !important;
        }

        /* Updated: Increased z-index for modals to ensure they overlay map elements */
        #aiModal, #historyModal, #weatherModal, #settingsModal, #shareModal { transition: opacity 0.3s ease-in-out; z-index: 2000; }
        
        #aiModal.hidden, #historyModal.hidden, #weatherModal.hidden, #settingsModal.hidden, #shareModal.hidden { opacity: 0; pointer-events: none; }
        #aiModal:not(.hidden), #historyModal:not(.hidden), #weatherModal:not(.hidden), #settingsModal:not(.hidden), #shareModal:not(.hidden) { opacity: 1; pointer-events: auto; }
        
        #toast { transition: transform 0.3s ease-in-out, opacity 0.3s; z-index: 3000; }
        #toast.hidden { transform: translateY(100%); opacity: 0; }

        [contenteditable="true"] { border: 1px dashed #0ea5e9; padding: 2px; border-radius: 4px; background-color: #f0f9ff; outline: none; }
        [contenteditable="true"]:focus { border: 1px solid #0ea5e9; background-color: white; }
        
        .touch-btn { min-height: 44px; min-width: 44px; display: flex; align-items: center; justify-content: center; }
        
        @media (max-width: 767px) {
            .touch-btn { min-height: 48px; min-width: 48px; padding: 8px !important; }
            header { min-height: auto; }
        }
    </style>
</head>
<body>

    <!-- Core Utilities -->
    <script>
        window.onerror = function(msg, url, line, col, error) { console.error("App Error:", msg, error); };
        window.showToast = function(msg) { 
            const t = document.getElementById('toast'); if(!t) return; 
            document.getElementById('toastMsg').innerText = msg; t.classList.remove('hidden'); 
            setTimeout(() => t.classList.add('hidden'), 3000); 
        };
        window.closeModal = function(id) { document.getElementById(id).classList.add('hidden'); };
        window.safeStorage = { 
            getItem: (key) => { try { return localStorage.getItem(key); } catch (e) { return null; } }, 
            setItem: (key, val) => { try { localStorage.setItem(key, val); } catch (e) { } } 
        };
        window.copyToClipboard = async function(text) {
            try { await navigator.clipboard.writeText(text); return true; } catch (err) {
                const textArea = document.createElement("textarea");
                textArea.value = text; textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.position = "fixed";
                document.body.appendChild(textArea); textArea.focus(); textArea.select();
                try { const success = document.execCommand('copy'); document.body.removeChild(textArea); return success; } catch (err) { document.body.removeChild(textArea); return false; }
            }
        };
        // Global Triggers
        window.openAIModal = () => document.getElementById('aiModal').classList.remove('hidden');
        window.openHistoryModal = () => document.getElementById('historyModal').classList.remove('hidden');
        window.openShareModal = () => document.getElementById('shareModal').classList.remove('hidden');
        window.openSettingsModal = () => {
            const savedKey = window.safeStorage.getItem('gemini_api_key');
            if(savedKey) document.getElementById('settingsApiKey').value = savedKey;
            document.getElementById('settingsModal').classList.remove('hidden');
        };
        window.fillExamplePrompt = (e) => {
            e.preventDefault();
            document.getElementById('aiPromptInput').value = "è¦åŠƒä¸€å€‹åŒ—æµ·é“ 5 å¤© 4 å¤œçš„å†¬å­£è¡Œç¨‹ï¼Œæƒ³è¦çœ‹ä¼éµæ•£æ­¥ã€åƒå¸ç‹èŸ¹ã€æ³¡æº«æ³‰ï¼Œäº¤é€šä»¥å¤§çœ¾é‹è¼¸ç‚ºä¸»ã€‚";
            const date = new Date(); date.setMonth(date.getMonth() + 1);
            document.getElementById('aiStartDate').value = date.toISOString().split('T')[0];
        };
    </script>

    <!-- Header -->
    <header class="bg-sky-500 text-white px-2 sm:px-3 py-2 shadow-lg flex justify-between items-center z-20 flex-wrap gap-2">
        <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-shrink-0">
            <div class="bg-white/20 p-1.5 sm:p-2.5 rounded-full flex-shrink-0"><i class="fa-solid fa-earth-americas text-xl sm:text-2xl"></i></div>
            <div class="hidden sm:block">
                <h1 class="font-bold text-lg sm:text-xl leading-tight">å…¨çƒæ—…éŠ AI åš®å°</h1>
                <p class="text-xs text-sky-100 uppercase tracking-wider flex items-center gap-1">AI Planner <span id="modeBadge" class="bg-white/20 px-1.5 py-0.5 rounded text-[10px]">Cloud</span></p>
            </div>
            <h1 class="sm:hidden font-bold text-base leading-tight">å…¨çƒæ—…éŠ AI åš®å°</h1>
        </div>
        
        <div class="hidden md:flex gap-2 items-center flex-shrink-0">
            <button onclick="openSettingsModal()" id="settingsBtn" class="bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-full flex items-center gap-2 transition-colors border border-white/20 touch-btn text-sm" title="é€£çµ AI"><i id="settingsIcon" class="fa-solid fa-link text-base"></i> <span id="keyStatusText" class="text-sm font-bold">é€£çµ AI</span></button>
            <button onclick="openShareModal()" class="bg-sky-600 hover:bg-sky-700 text-white px-3 py-2 rounded-full font-bold shadow-sm flex items-center gap-2 active:scale-95 border border-white/20 touch-btn text-sm"><i class="fa-solid fa-share-nodes text-base"></i> <span>åˆ†äº«</span></button>
            <button onclick="openHistoryModal()" class="bg-sky-600 hover:bg-sky-700 text-white px-3 py-2 rounded-full font-bold shadow-sm flex items-center gap-2 active:scale-95 border border-white/20 touch-btn text-sm"><i class="fa-solid fa-folder-open text-base"></i> <span>è¡Œç¨‹</span></button>
            <button onclick="saveCurrentItinerary()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-full font-bold shadow-sm flex items-center gap-2 active:scale-95 border border-white/20 touch-btn text-sm"><i class="fa-solid fa-floppy-disk text-base"></i> <span>å„²å­˜</span></button>
            <button onclick="openAIModal()" class="bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-white px-3 py-2 rounded-full font-bold shadow-md flex items-center gap-2 active:scale-95 border border-white/20 touch-btn text-sm"><i class="fa-solid fa-wand-magic-sparkles text-base"></i> <span>è¦åŠƒ</span></button>
            <button onclick="window.openFlightSearch()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-full font-bold shadow-md flex items-center gap-2 active:scale-95 border border-white/20 touch-btn text-sm"><i class="fa-solid fa-plane text-base"></i> <span>èˆªç­</span></button>
        </div>
        
        <div class="md:hidden flex gap-1.5 items-center justify-end flex-wrap w-full">
            <button onclick="openSettingsModal()" id="settingsBtnMobile" class="bg-white/10 hover:bg-white/20 text-white p-2 rounded-full flex items-center gap-0 transition-colors border border-white/20 touch-btn"><i class="fa-solid fa-link text-base"></i></button>
            <button onclick="openShareModal()" class="bg-sky-600 hover:bg-sky-700 text-white p-2 rounded-full font-bold shadow-sm flex items-center gap-0 active:scale-95 border border-white/20 touch-btn"><i class="fa-solid fa-share-nodes text-base"></i></button>
            <button onclick="openHistoryModal()" class="bg-sky-600 hover:bg-sky-700 text-white p-2 rounded-full font-bold shadow-sm flex items-center gap-0 active:scale-95 border border-white/20 touch-btn"><i class="fa-solid fa-folder-open text-base"></i></button>
            <button onclick="saveCurrentItinerary()" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-full font-bold shadow-sm flex items-center gap-0 active:scale-95 border border-white/20 touch-btn"><i class="fa-solid fa-floppy-disk text-base"></i></button>
            <button onclick="openAIModal()" class="bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-white p-2 rounded-full font-bold shadow-md flex items-center gap-0 active:scale-95 border border-white/20 touch-btn"><i class="fa-solid fa-wand-magic-sparkles text-base"></i></button>
            <button onclick="window.openFlightSearch()" class="bg-purple-500 hover:bg-purple-600 text-white p-2 rounded-full font-bold shadow-md flex items-center gap-0 active:scale-95 border border-white/20 touch-btn"><i class="fa-solid fa-plane text-base"></i></button>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Left Panel -->
        <section id="itineraryPanel" class="mobile-tab-content active panel-container md:w-[450px] bg-white border-r border-slate-200">
            <div class="bg-sky-50 p-3 border-b border-sky-100 flex justify-between items-center text-sm text-sky-800 select-none shrink-0" id="headerInfo">
                <div class="flex gap-2 overflow-x-auto no-scrollbar">
                    <span class="flex items-center gap-1 cursor-pointer hover:bg-sky-100 px-2 py-1 rounded transition-colors whitespace-nowrap" onclick="toggleCurrency()"><i class="fa-solid fa-coins text-sky-600"></i> <span id="headerCurrency" class="font-medium">--</span></span>
                    <span class="flex items-center gap-1 cursor-pointer hover:bg-sky-100 px-2 py-1 rounded transition-colors whitespace-nowrap" onclick="openWeatherModal()"><i class="fa-solid fa-cloud-sun text-sky-600"></i> å¤©æ°£</span>
                    <!-- Location removed from here as requested -->
                </div>
                <button id="editToggleBtn" onclick="toggleEditMode()" class="text-sky-600 hover:bg-sky-100 px-3 py-1.5 rounded transition-colors flex items-center gap-2 font-medium shrink-0"><i class="fa-regular fa-pen-to-square"></i> <span id="editBtnText">ç·¨è¼¯</span></button>
            </div>
            <div id="dayTabsContainer" class="flex overflow-x-auto bg-white p-2 border-b border-slate-100 gap-2 shrink-0 no-scrollbar shadow-sm" style="min-height: 60px;"></div>
            <div id="contentList" class="p-4 space-y-4 bg-slate-50"></div> 
        </section>

        <!-- Right Panel (Map) -->
        <section id="mapPanel" class="mobile-tab-content panel-container w-full md:flex-1 bg-slate-100">
            <div id="map"></div>
            <!-- Updated: Lowered z-index to 30 to stay below modals (z-2000) -->
            <div class="absolute top-4 left-4 z-30 w-80 max-w-[calc(100%-2rem)] md:w-96">
                <div class="flex gap-2">
                    <input type="text" id="mapSearchInput" placeholder="æœå°‹åœ°é»..." class="flex-1 p-3 rounded-lg border border-slate-200 shadow-md focus:ring-2 focus:ring-sky-500 outline-none text-sm" />
                    <button onclick="window.searchMapLocation()" class="bg-sky-500 hover:bg-sky-600 text-white p-3 rounded-lg shadow-md font-bold flex items-center justify-center touch-btn"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>
                <div id="mapSearchResults" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-lg shadow-lg max-h-64 overflow-y-auto border border-slate-200 z-50"></div>
            </div>
            <div class="absolute top-4 right-4 z-30 flex flex-col gap-3">
                <button onclick="map.zoomIn()" class="w-12 h-12 bg-white rounded shadow text-slate-600 hover:text-sky-600 font-bold text-2xl flex items-center justify-center">+</button>
                <button onclick="map.zoomOut()" class="w-12 h-12 bg-white rounded shadow text-slate-600 hover:text-sky-600 font-bold text-2xl flex items-center justify-center">-</button>
            </div>
            <button onclick="refreshMapLayout()" class="absolute bottom-24 right-4 z-30 w-12 h-12 bg-white rounded-full shadow text-slate-600 hover:text-sky-600 flex items-center justify-center md:hidden" title="é‡æ•´åœ°åœ–"><i class="fa-solid fa-rotate text-lg"></i></button>
        </section>
    </main>

    <!-- Mobile Nav -->
    <nav class="md:hidden flex h-20 bg-white border-t border-slate-200 shrink-0 z-30 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] pb-[env(safe-area-inset-bottom)]">
        <button onclick="toggleMobileView('list')" id="nav-list" class="flex-1 flex flex-col items-center justify-center text-sky-600 touch-btn"><i class="fa-solid fa-list-check text-2xl mb-1"></i><span class="text-xs font-bold">è¡Œç¨‹åˆ—è¡¨</span></button>
        <button onclick="toggleMobileView('map')" id="nav-map" class="flex-1 flex flex-col items-center justify-center text-slate-400 touch-btn"><i class="fa-regular fa-map text-2xl mb-1"></i><span class="text-xs font-bold">åœ°åœ–æ¨¡å¼</span></button>
    </nav>

    <!-- Modals -->
    <div id="shareModal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-sky-600 p-4 flex justify-between items-center text-white shrink-0"><h3 class="font-bold text-lg"><i class="fa-solid fa-share-nodes mr-2"></i>åˆ†äº«è¡Œç¨‹</h3><button onclick="closeModal('shareModal')" class="text-white/80 hover:text-white p-2"><i class="fa-solid fa-xmark text-2xl"></i></button></div>
            <div class="p-6 space-y-5 overflow-y-auto text-base">
                <!-- Updated URL -->
                <button onclick="copyWebLink()" class="w-full py-3.5 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-xl font-bold hover:from-pink-600 hover:to-purple-700 shadow-md flex items-center justify-center gap-2"><i class="fa-solid fa-link text-lg"></i> è¤‡è£½æ‡‰ç”¨ç¨‹å¼é€£çµ</button>
                <div class="border-t border-slate-100 my-2"></div>
                <button onclick="shareToLine()" class="w-full py-3.5 bg-[#06C755] text-white rounded-xl font-bold hover:bg-[#05b64d] shadow-sm flex items-center justify-center gap-2"><i class="fa-brands fa-line text-xl"></i> åˆ†äº«åˆ° LINE</button>
                <button onclick="shareAsCode()" class="w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-sm flex items-center justify-center gap-2"><i class="fa-solid fa-code text-lg"></i> è¤‡è£½è¡Œç¨‹è³‡æ–™ç¢¼</button>
            </div>
        </div>
    </div>

    <div id="aiModal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden"><div class="bg-gradient-to-r from-sky-500 to-blue-600 p-4 flex justify-between items-center text-white"><h3 class="font-bold text-xl"><i class="fa-solid fa-plane-up mr-2"></i>AI è¡Œç¨‹è¦åŠƒ</h3><button onclick="closeModal('aiModal')" class="text-white/80 hover:text-white p-2"><i class="fa-solid fa-xmark text-2xl"></i></button></div><div class="p-6 space-y-4"><div class="mb-2"><label class="block text-sm font-bold text-slate-500 mb-1 uppercase">å‡ºç™¼æ—¥æœŸ</label><input type="date" id="aiStartDate" class="w-full p-3 border border-slate-200 rounded-lg text-base bg-slate-50 text-slate-700"></div><div class="mb-2"><label class="block text-sm font-bold text-slate-500 mb-1 uppercase">æ—…éŠåå¥½</label><textarea id="aiPromptInput" class="w-full p-4 border border-slate-200 rounded-lg text-base bg-slate-50" rows="4" placeholder="ä¾‹ï¼šè¦åŠƒä¸€å€‹äº¬éƒ½ 5 å¤© 4 å¤œçš„è³æ¥“è¡Œç¨‹ï¼Œè¦åŒ…å«åµå±±å°ç«è»Š..."></textarea></div><div class="text-right"><a href="#" onclick="fillExamplePrompt(event)" class="text-sm text-sky-500 hover:underline">âš¡ è©¦è©¦ç¯„ä¾‹</a></div><div id="aiErrorMsg" class="hidden mt-2 text-red-500 text-sm flex items-center gap-1"><i class="fa-solid fa-circle-exclamation"></i> <span>ç™¼ç”ŸéŒ¯èª¤</span></div><div class="mt-4 flex gap-4"><button onclick="closeModal('aiModal')" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">å–æ¶ˆ</button><button onclick="window.handleGenerateClick()" id="generateBtn" class="flex-1 py-3 bg-sky-500 text-white rounded-xl font-bold hover:bg-sky-600 shadow-lg flex justify-center items-center gap-2"><span>å‡ºç™¼ï¼</span><i class="fa-solid fa-paper-plane"></i></button></div></div></div></div>
    
    <div id="historyModal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md h-[80vh] flex flex-col overflow-hidden"><div class="bg-slate-800 p-4 flex justify-between items-center text-white shrink-0"><h3 class="font-bold text-xl"><i class="fa-solid fa-folder-open mr-2"></i>æˆ‘çš„è¡Œç¨‹</h3><div class="flex items-center gap-3"><button onclick="importItinerary()" class="text-sky-300 hover:text-white text-sm font-bold flex items-center gap-1 p-2"><i class="fa-solid fa-file-import text-lg"></i> åŒ¯å…¥</button><button onclick="closeModal('historyModal')" class="text-white/80 hover:text-white p-2"><i class="fa-solid fa-xmark text-2xl"></i></button></div></div><div id="historyList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50"><div class="text-center text-slate-400 mt-10">è¼‰å…¥ä¸­...</div></div></div></div>
    
    <div id="weatherModal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md h-[70vh] flex flex-col overflow-hidden"><div class="bg-orange-500 p-4 flex justify-between items-center text-white shrink-0"><h3 class="font-bold text-xl"><i class="fa-solid fa-cloud-sun mr-2"></i>å…¨ç¨‹å¤©æ°£æ¦‚æ³</h3><button onclick="closeModal('weatherModal')" class="text-white/80 hover:text-white p-2"><i class="fa-solid fa-xmark text-2xl"></i></button></div><div id="weatherList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-orange-50"><div class="text-center text-slate-400 mt-10">è¼‰å…¥ä¸­...</div></div></div></div>
    
    <div id="settingsModal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden"><div class="bg-slate-800 p-4 flex justify-between items-center text-white shrink-0"><h3 class="font-bold text-xl"><i class="fa-solid fa-robot mr-2"></i>é€£çµ Google AI</h3><button onclick="closeModal('settingsModal')" class="text-white/80 hover:text-white p-2"><i class="fa-solid fa-xmark text-2xl"></i></button></div><div class="p-6 space-y-6"><div class="space-y-2"><p class="text-sm font-bold text-slate-400 uppercase">ç¬¬ä¸€æ­¥ï¼šå–å¾—å…è²»é‡‘é‘°</p><a href="https://aistudio.google.com/app/apikey" target="_blank" class="flex items-center justify-between w-full py-3.5 px-5 bg-sky-50 text-sky-700 rounded-xl font-bold hover:bg-sky-100 transition-colors border border-sky-100 group"><span class="flex items-center gap-2"><i class="fa-brands fa-google text-xl"></i> é–‹å•Ÿ Google AI Studio</span><i class="fa-solid fa-arrow-up-right-from-square text-sm opacity-50 group-hover:opacity-100"></i></a></div><div class="border-t border-slate-100"></div><div class="space-y-2"><p class="text-sm font-bold text-slate-400 uppercase">ç¬¬äºŒæ­¥ï¼šè²¼ä¸Šä¸¦é€£çµ</p><div class="flex gap-2"><input type="password" id="settingsApiKey" class="flex-1 p-3.5 border border-slate-300 rounded-lg text-base bg-white focus:ring-2 focus:ring-sky-500 outline-none" placeholder="åœ¨æ­¤è²¼ä¸Š API Key..."><button onclick="pasteApiKey()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 rounded-lg border border-slate-200 transition-colors flex flex-col items-center justify-center whitespace-nowrap" title="è®€å–å‰ªè²¼ç°¿"><i class="fa-regular fa-clipboard text-lg"></i><span class="text-xs font-bold">è²¼ä¸Š</span></button></div></div><button onclick="saveSettings()" class="w-full py-3.5 bg-sky-600 text-white rounded-xl text-base font-bold hover:bg-sky-700 shadow-lg flex justify-center items-center gap-2"><i class="fa-solid fa-link"></i> ç¢ºèªé€£çµ</button><div class="text-center pt-2"><button onclick="useDemoMode()" class="text-sm text-slate-400 hover:text-slate-600 hover:underline">å…ˆä½¿ç”¨æ¨¡æ“¬æ¨¡å¼è©¦ç©</button></div></div></div></div>
    
    <div id="toast" class="hidden fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-5 py-3 rounded-full shadow-xl z-[3000] text-base font-bold flex items-center gap-3"><i class="fa-solid fa-check-circle text-green-400 text-xl"></i> <span id="toastMsg">å·²å„²å­˜</span></div>

    <!-- Firebase & Hybrid Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        let app, auth, db;
        let isLocalMode = false;
        let currentUser = null;
        let historyUnsubscribe = null;

        try {
            if (typeof __firebase_config !== 'undefined' && typeof __app_id !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } 
                    else { await signInAnonymously(auth); }
                };
                initAuth();
                onAuthStateChanged(auth, (user) => { currentUser = user; if (user) setupHistoryListener(user.uid); });
            } else { throw new Error("Missing Env Config"); }
        } catch (e) {
            isLocalMode = true;
            document.getElementById('modeBadge').innerText = "Local";
            document.getElementById('modeBadge').className = "bg-orange-500/20 text-orange-200 px-1 rounded text-[8px] border border-orange-400/30";
            currentUser = { uid: 'local_user' };
            setTimeout(() => setupHistoryListener('local_user'), 500);
        }
        
        window.saveCurrentItinerary = async () => {
            if (!window.currentItineraryData) return;
            const saveBtn = document.querySelector('button[onclick="saveCurrentItinerary()"]');
            let originalIcon = '';
            if(saveBtn) { originalIcon = saveBtn.innerHTML; saveBtn.innerHTML = `<div class="loader w-4 h-4 border-2 border-white border-t-transparent"></div>`; saveBtn.disabled = true; }

            try {
                // Modified: Filename as Country - Title
                let title = "æœªå‘½åè¡Œç¨‹";
                const day1 = window.currentItineraryData["1"];
                const meta = window.currentMetaData || {};
                
                if (day1 && day1.title) {
                    const rawTitle = day1.title.split(':')[0].replace(/Day \d+/, '').trim() || day1.title;
                    const country = meta.country || (meta.main_location ? meta.main_location.split(',')[0] : 'æ—…ç¨‹');
                    title = `[${country}] ${rawTitle}`;
                }
                
                if (meta.startDate) title += ` (${meta.startDate})`;

                const docData = { title: title, data: window.currentItineraryData, meta: meta, updatedAt: isLocalMode ? new Date().toISOString() : Timestamp.now() };

                if (window.currentDocId) {
                    if (isLocalMode) {
                        let localHistory = JSON.parse(window.safeStorage.getItem('travel_history') || '[]');
                        const index = localHistory.findIndex(item => item.id === window.currentDocId);
                        if (index !== -1) { localHistory[index] = { ...localHistory[index], ...docData }; window.safeStorage.setItem('travel_history', JSON.stringify(localHistory)); setupHistoryListener('local_user'); }
                    } else {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'global-travel-guide';
                        await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'itineraries', window.currentDocId), docData);
                    }
                    window.showToast("è¡Œç¨‹å·²æ›´æ–°ï¼");
                } else {
                    if (!docData.createdAt) docData.createdAt = docData.updatedAt;
                    if (isLocalMode) {
                        const newId = 'loc_' + Date.now();
                        window.currentDocId = newId;
                        const localHistory = JSON.parse(window.safeStorage.getItem('travel_history') || '[]');
                        localHistory.unshift({ id: newId, ...docData });
                        window.safeStorage.setItem('travel_history', JSON.stringify(localHistory));
                        setupHistoryListener('local_user');
                    } else {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'global-travel-guide';
                        const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'itineraries'), docData);
                        window.currentDocId = docRef.id;
                    }
                    window.showToast("æ–°è¡Œç¨‹å·²å„²å­˜ï¼");
                }
            } catch (e) { window.showToast("å„²å­˜å¤±æ•—"); console.error(e); } 
            finally { if(saveBtn) { saveBtn.innerHTML = originalIcon; saveBtn.disabled = false; } }
        };

        window.deleteItinerary = async (docId) => {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ')) return;
            try {
                if (isLocalMode) {
                    let localHistory = JSON.parse(window.safeStorage.getItem('travel_history') || '[]');
                    localHistory = localHistory.filter(item => item.id !== docId);
                    window.safeStorage.setItem('travel_history', JSON.stringify(localHistory));
                    setupHistoryListener('local_user');
                } else {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'global-travel-guide';
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'itineraries', docId));
                }
                window.showToast("è¡Œç¨‹å·²åˆªé™¤");
            } catch (e) { window.showToast("åˆªé™¤å¤±æ•—"); }
        };

        function setupHistoryListener(userId) {
            const listEl = document.getElementById('historyList');
            if (isLocalMode) {
                const renderLocal = () => {
                    const localHistory = JSON.parse(window.safeStorage.getItem('travel_history') || '[]');
                    if (localHistory.length === 0) { listEl.innerHTML = '<div class="text-center text-slate-400 mt-10">å°šç„¡å„²å­˜çš„è¡Œç¨‹</div>'; return; }
                    listEl.innerHTML = '';
                    localHistory.forEach(data => { createHistoryItem(listEl, data.id, data, new Date(data.createdAt || Date.now()).toLocaleDateString()); });
                };
                renderLocal(); return;
            }
            if (historyUnsubscribe) historyUnsubscribe();
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'global-travel-guide';
            const q = query(collection(db, 'artifacts', appId, 'users', userId, 'itineraries'), orderBy('createdAt', 'desc'));
            historyUnsubscribe = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) { listEl.innerHTML = '<div class="text-center text-slate-400 mt-10">å°šç„¡å„²å­˜çš„è¡Œç¨‹</div>'; return; }
                listEl.innerHTML = '';
                snapshot.forEach(docSnap => { createHistoryItem(listEl, docSnap.id, docSnap.data(), new Date(docSnap.data().createdAt.seconds * 1000).toLocaleDateString()); });
            });
        }

        function createHistoryItem(container, id, data, date) {
            const item = document.createElement('div');
            item.className = "bg-white p-4 rounded-xl border border-slate-200 hover:border-sky-400 cursor-pointer shadow-sm transition-all group relative";
            item.innerHTML = `<div class="flex justify-between items-center"><div class="flex-1" onclick="window.loadItineraryWrapper('${id}')"><h4 class="font-bold text-slate-800 group-hover:text-sky-600 text-lg">${data.title || 'è¡Œç¨‹'}</h4><p class="text-xs text-slate-400 mt-1"><i class="fa-regular fa-clock"></i> ${date}</p></div><div class="flex items-center gap-3"><button onclick="event.stopPropagation(); window.deleteItinerary('${id}')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-red-50 text-slate-300 hover:text-red-500 transition-colors z-20" title="åˆªé™¤"><i class="fa-solid fa-trash text-lg"></i></button><i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-sky-500 text-lg"></i></div></div>`;
            if (!window.historyCache) window.historyCache = {};
            window.historyCache[id] = { data: data.data, meta: data.meta };
            container.appendChild(item);
        }

        window.loadItineraryWrapper = (id) => {
            if (window.historyCache && window.historyCache[id]) {
                const { data, meta } = window.historyCache[id];
                window.loadItineraryFromHistory(data, meta, id);
                window.closeModal('historyModal');
            }
        };
    </script>

    <!-- Leaflet & Main UI Logic -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const envApiKey = ""; 
        // const OPENWEATHER_API_KEY = ""; // Removed: Key handled by backend proxy
        window.currentItineraryData = null;
        window.currentMetaData = null;
        window.currentDocId = null;
        let map, markersLayer = null, currentPolyline = null, currentBounds = null, currentDay = 1;
        let isEditMode = false;
        let weatherCache = {}; 
        
        async function copyToClipboard(text) {
            try { await navigator.clipboard.writeText(text); return true; } catch (err) {
                const textArea = document.createElement("textarea");
                textArea.value = text; textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.position = "fixed";
                document.body.appendChild(textArea); textArea.focus(); textArea.select();
                try { const success = document.execCommand('copy'); document.body.removeChild(textArea); return success; } catch (err) { document.body.removeChild(textArea); return false; }
            }
        }

        window.onload = () => {
            initMap();
            const urlParams = new URLSearchParams(window.location.search);
            const urlKey = urlParams.get('key');
            if (urlKey) { window.safeStorage.setItem('gemini_api_key', urlKey); window.history.replaceState({}, document.title, window.location.pathname); }
            
            // Updated Default Data with Country, Location, and Cost Estimates
            const defaultData = {
                1: { title: "Day 1: äº¬éƒ½åˆå°è±¡", weather: "æ™´æ™‚å¤šé›² 24Â°C", desc: "é«”é©—å¤éƒ½çš„å¯§éœèˆ‡ç¹è¯ã€‚", stops: [{ id: 101, time: "ä¸Šåˆ", name: "æ¸…æ°´å¯º", lat: 34.9948, lng: 135.7850, icon: "fa-torii-gate", desc: "äº¬éƒ½æœ€è‘—åçš„å¤è€å¯ºé™¢ã€‚", transport: { mode: "å·´å£«", desc: "äº¬éƒ½ç«™æ­ä¹˜ 206 è™Ÿ", price: "230 æ—¥åœ“", duration: "20 åˆ†", steps: ["å‰å¾€äº¬éƒ½ç«™ D2 ä¹˜è»Šè™•", "æ­ä¹˜ 206 è™Ÿå…¬è»Š", "äº”æ¢å‚ä¸‹è»Š"] }, tips: "æ—©é»å»é¿é–‹äººæ½®ã€‚", tags: ["å¤è¹Ÿ"] }] }
            };
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('aiStartDate').value = today;
            // Added country, main_location, and estimated_costs
            const defaultMeta = { 
                currency: "1 TWD â‰ˆ 4.7 JPY", 
                weather_summary: "å¹³å‡ 24Â°C", 
                startDate: today,
                country: "Japan",
                main_location: "æ—¥æœ¬, äº¬éƒ½",
                estimated_costs: {
                    accommodation: 40000,
                    transport: 5000,
                    food: 12000,
                    total: 57000,
                    currency: "JPY"
                }
            };
            loadItineraryFromHistory(defaultData, defaultMeta, null);
            
            setTimeout(() => {
                const savedKey = window.safeStorage.getItem('gemini_api_key') || envApiKey;
                if(savedKey) window.updateAPIKeyStatus(true);
            }, 100);
        };
        
        window.updateAPIKeyStatus = (isConnected) => {
            const statusText = document.getElementById('keyStatusText');
            const icon = document.querySelector('#settingsBtn i');
            const btn = document.getElementById('settingsBtn');
            const btnMobile = document.getElementById('settingsBtnMobile');
            
            if(isConnected) {
                if(statusText) statusText.innerText = "å·²é€£çµ AI";
                if(icon) icon.className = "fa-solid fa-check text-green-400";
                const activeClasses = ['bg-green-500/10', 'border-green-400/30'];
                const inactiveClasses = ['bg-white/10', 'border-white/20'];
                if(btn) { btn.classList.add(...activeClasses); btn.classList.remove(...inactiveClasses); }
                if(btnMobile) { btnMobile.classList.add(...activeClasses); btnMobile.classList.remove(...inactiveClasses); }
            } else {
                if(statusText) statusText.innerText = "é€£çµ AI";
                if(icon) icon.className = "fa-solid fa-link text-base";
            }
        };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([34.9948, 135.7850], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OSM &copy; CARTO', subdomains: 'abcd', maxZoom: 20 }).addTo(map);
            // Updated: Initialize LayerGroup for markers
            markersLayer = L.layerGroup().addTo(map);
            setTimeout(() => { map.invalidateSize(); }, 200);
        }
        
        window.refreshMapLayout = () => {
            if(map) {
                map.invalidateSize();
                if(currentBounds && map.getContainer().offsetWidth > 0) map.fitBounds(currentBounds);
                window.showToast("åœ°åœ–å·²é‡æ•´");
            }
        };

        window.loadItineraryFromHistory = (data, meta, docId) => {
            window.currentItineraryData = data;
            window.currentMetaData = meta || {};
            window.currentDocId = docId; 
            updateHeader(meta);
            renderTabs();
            const days = Object.keys(data);
            if(days.length > 0) switchDay(days[0]);
            isEditMode = false; updateEditUI();
            window.showToast("è¡Œç¨‹å·²è¼‰å…¥");
        };

        function updateHeader(meta) {
            const currencyEl = document.getElementById('headerCurrency');
            if(meta && meta.currency) currencyEl.innerText = meta.currency;
            else currencyEl.innerText = 'åŒ¯ç‡æœªçŸ¥';
            
            // Location removed from header logic
        }

        window.fetchWeatherData = async (lat, lng, dayIndex) => {
            const cacheKey = `${lat},${lng},${dayIndex}`;
            if (weatherCache[cacheKey]) return weatherCache[cacheKey];
            
            try {
                // Call Cloudflare Pages Function at root path /weather
                const url = `/weather?lat=${lat}&lon=${lng}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    if (response.status === 404) {
                       console.warn("Weather function not found. (Check deployment or local dev)");
                       return null;
                    }
                    throw new Error('å¤©æ°£APIæŸ¥è©¢å¤±æ•—');
                }
                const data = await response.json();
                return data; 
            } catch (error) {
                console.error('å¤©æ°£æŸ¥è©¢éŒ¯èª¤:', error);
                return null;
            }
        };

        window.getWeatherForDay = async (lat, lng, dayIndex) => {
            const weatherData = await window.fetchWeatherData(lat, lng, dayIndex);
            if (!weatherData) return null;
            
            const list = weatherData.list;
            const targetDate = new Date();
            // Assuming Day 1 is "Today" or Metadata Start Date
            if(window.currentMetaData && window.currentMetaData.startDate) {
                const start = new Date(window.currentMetaData.startDate);
                targetDate.setTime(start.getTime() + (dayIndex - 1) * 86400000);
            } else {
                targetDate.setDate(targetDate.getDate() + dayIndex - 1);
            }

            const targetDateStr = targetDate.toISOString().split('T')[0];
            const dayForecasts = list.filter(item => item.dt_txt.startsWith(targetDateStr));
            
            let result = {};
            let isRef = false;

            if (dayForecasts.length === 0) {
                 // Fallback to first available data (Current/Soonest)
                 const current = list[0];
                 if(!current) return null; // Should not happen if API worked
                 isRef = true;
                 
                 result = {
                    temp: Math.round(current.main.temp),
                    minTemp: current.main.temp_min,
                    maxTemp: current.main.temp_max,
                    feelsLike: Math.round(current.main.feels_like),
                    description: current.weather[0].main,
                    icon: current.weather[0].icon,
                    humidity: current.main.humidity,
                    windSpeed: current.wind.speed,
                    precipitation: (current.rain && current.rain['3h']) || 0,
                    locationName: weatherData.city ? weatherData.city.name : "æ­¤åœ°",
                    isReference: true
                 };
            } else {
                const temps = dayForecasts.map(f => f.main.temp);
                const avgTemp = Math.round(temps.reduce((a, b) => a + b, 0) / temps.length);
                const minTemp = Math.min(...temps);
                const maxTemp = Math.max(...temps);
                const weather = dayForecasts[0].weather[0];
                const humidity = dayForecasts[0].main.humidity;
                const windSpeed = dayForecasts[0].wind.speed;
                const feelsLike = Math.round(dayForecasts[0].main.feels_like);
                const precipitation = dayForecasts.reduce((sum, f) => sum + (f.rain?.['3h'] || 0), 0);
                
                result = {
                    temp: avgTemp,
                    minTemp: minTemp,
                    maxTemp: maxTemp,
                    feelsLike: feelsLike,
                    description: weather.main,
                    icon: weather.icon,
                    humidity: humidity,
                    windSpeed: windSpeed,
                    precipitation: precipitation,
                    locationName: weatherData.city ? weatherData.city.name : "æ­¤åœ°",
                    isReference: false
                };
            }
            
            return result;
        };
        
        window.getClothingSuggestion = (temp, weatherType) => {
             // Simple Clothing Logic
             if(temp < 10) return "ğŸ§¥ å¯’å†·ï¼šç©¿åšå¤–å¥—ã€åœå·¾";
             if(temp < 20) return "ğŸ‘• æ¶¼çˆ½ï¼šè–„å¤–å¥—ã€é•·è¢–";
             if(temp < 28) return "ğŸ‘š èˆ’é©ï¼šçŸ­è¢–ã€è–„é•·è¤²";
             return "â˜€ï¸ ç‚ç†±ï¼šé€æ°£è¡£ç‰©ã€é˜²æ›¬";
        };

        window.toggleEditMode = () => { if (isEditMode) saveEdits(); isEditMode = !isEditMode; updateEditUI(); };

        function updateEditUI() {
            const btnText = document.getElementById('editBtnText');
            const icon = document.querySelector('#editToggleBtn i');
            const btn = document.getElementById('editToggleBtn');
            const editables = document.querySelectorAll('[data-editable]');
            if (isEditMode) {
                btnText.innerText = "å®Œæˆ"; icon.className = "fa-solid fa-check"; btn.classList.add('bg-green-100', 'text-green-700'); btn.classList.remove('text-sky-600', 'hover:bg-sky-100');
                editables.forEach(el => el.contentEditable = "true");
            } else {
                btnText.innerText = "ç·¨è¼¯"; icon.className = "fa-regular fa-pen-to-square"; btn.classList.remove('bg-green-100', 'text-green-700'); btn.classList.add('text-sky-600', 'hover:bg-sky-100');
                editables.forEach(el => el.contentEditable = "false");
            }
        }

        function saveEdits() {
            if(currentDay === 'summary') return;
            const dayData = window.currentItineraryData[currentDay];
            if (!dayData) return;
            const titleEl = document.getElementById('dayTitle');
            const descEl = document.getElementById('dayDesc');
            if(titleEl) dayData.title = titleEl.innerText;
            if(descEl) dayData.desc = descEl.innerText;
            dayData.stops.forEach(stop => {
                const nameEl = document.getElementById(`stop-name-${stop.id}`);
                const descEl = document.getElementById(`stop-desc-${stop.id}`);
                if(nameEl) stop.name = nameEl.innerText;
                if(descEl) stop.desc = descEl.innerText;
            });
            window.saveCurrentItinerary();
        }

        window.toggleCurrency = () => {
            const currencyStr = window.currentMetaData?.currency;
            if (!currencyStr) return;
            const regex = /1\s*([A-Z]+)\s*[â‰ˆ=]\s*([\d.]+)\s*([A-Z]+)/;
            const match = currencyStr.match(regex);
            if (match) {
                const source = match[1];
                const rate = parseFloat(match[2]);
                const target = match[3];
                if (!isNaN(rate) && rate !== 0) {
                    const newRate = (1 / rate).toFixed(4).replace(/\.?0+$/, '');
                    const newStr = `1 ${target} â‰ˆ ${newRate} ${source}`;
                    window.currentMetaData.currency = newStr;
                    updateHeader(window.currentMetaData);

                    // Update Estimated Costs Logic
                    if (window.currentMetaData.estimated_costs) {
                        const costs = window.currentMetaData.estimated_costs;
                        const factor = 1 / rate;
                        costs.accommodation = Math.round(costs.accommodation * factor);
                        costs.transport = Math.round(costs.transport * factor);
                        costs.food = Math.round(costs.food * factor);
                        costs.total = Math.round(costs.total * factor);
                        costs.currency = source;
                    }

                    // Refresh Summary if active
                    if (currentDay === 'summary') {
                         const container = document.getElementById('contentList');
                         container.innerHTML = '';
                         renderSummaryView(container);
                    }
                }
            }
        };

        window.openSettingsModal = () => { const savedKey = window.safeStorage.getItem('gemini_api_key'); if(savedKey) document.getElementById('settingsApiKey').value = savedKey; document.getElementById('settingsModal').classList.remove('hidden'); };
        window.saveSettings = () => {
            const key = document.getElementById('settingsApiKey').value.trim();
            if(key) {
                window.safeStorage.setItem('gemini_api_key', key);
                window.showToast("API Key å·²å„²å­˜");
                window.updateAPIKeyStatus(true);
                window.closeModal('settingsModal');
            } else { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key"); }
        };
        window.useDemoMode = () => { window.closeModal('settingsModal'); window.runMockGeneration(); };
        window.pasteApiKey = async () => { try { const text = await navigator.clipboard.readText(); document.getElementById('settingsApiKey').value = text; } catch (err) { alert('ç„¡æ³•è®€å–å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è²¼ä¸Š'); } };

        window.openShareModal = () => document.getElementById('shareModal').classList.remove('hidden');
        window.copyWebLink = async () => { const success = await window.copyToClipboard("https://travel-guide-pwa.pages.dev/"); if (success) alert("é€£çµå·²è¤‡è£½ï¼"); else alert("è¤‡è£½å¤±æ•—"); };
        window.shareAsCode = async () => {
            if (!window.currentItineraryData) return alert("ç„¡è¡Œç¨‹å¯åˆ†äº«");
            const jsonStr = JSON.stringify({ data: window.currentItineraryData, meta: window.currentMetaData });
            const compressed = LZString.compressToBase64(jsonStr);
            const success = await window.copyToClipboard(compressed);
            if (success) { alert("è¡Œç¨‹è³‡æ–™ç¢¼å·²è¤‡è£½ï¼(å·²å£“ç¸®)"); window.closeModal('shareModal'); } else { alert("è¤‡è£½å¤±æ•—"); }
        };
        
        window.importItinerary = () => {
            const code = prompt("è«‹è²¼ä¸Šè¡Œç¨‹è³‡æ–™ç¢¼ï¼š"); if (!code) return;
            try {
                let jsonStr = '';
                try { jsonStr = LZString.decompressFromBase64(code); } catch (e) { jsonStr = decodeURIComponent(escape(atob(code))); }
                if (!jsonStr) throw new Error("è§£å£“å¤±æ•—");
                const shared = JSON.parse(jsonStr);
                if (shared && shared.data) { window.loadItineraryFromHistory(shared.data, shared.meta, null); window.saveCurrentItinerary(); window.closeModal('historyModal'); alert("è¡Œç¨‹åŒ¯å…¥æˆåŠŸï¼"); } else { alert("ç„¡æ•ˆçš„è¡Œç¨‹ç¢¼"); }
            } catch (e) { alert("åŒ¯å…¥å¤±æ•—"); }
        };
        window.shareToLine = () => {
            const data = window.currentItineraryData; const meta = window.currentMetaData; if (!data) return;
            let text = `âœˆï¸ ${meta.main_location || meta.country || 'æ—…éŠ'}è¡Œç¨‹ï¼š${meta.startDate || ''}\n`;
            Object.keys(data).forEach(day => { text += `\nã€Day ${day}ã€‘\n`; data[day].stops.forEach((stop,idx) => { text += `${idx+1}. ${stop.name}\n`; }); });
            window.open('https://line.me/R/msg/text/?' + encodeURIComponent(text));
        };

        // Weather with Location Accuracy
        window.openWeatherModal = async () => {
            const list = document.getElementById('weatherList'); 
            list.innerHTML = '<div class="text-center text-slate-400 mt-10">è¼‰å…¥ä¸­...</div>'; 
            if(!window.currentItineraryData) return;
            
            list.innerHTML = '';
            let dayIndex = 1;
            
            // Iterate through days and use the first stop location for each day
            for (let dayKey of Object.keys(window.currentItineraryData)) {
                const day = window.currentItineraryData[dayKey];
                let lat, lng;
                
                // Get location for THIS day
                if (day.stops && day.stops.length > 0) {
                    lat = day.stops[0].lat;
                    lng = day.stops[0].lng;
                }
                
                const displayDate = getDisplayDate(dayKey);
                const item = document.createElement('div');
                item.className = "bg-white p-4 rounded-xl border border-orange-100 shadow-sm flex flex-col gap-2";
                
                if (lat && lng) {
                    const weatherData = await window.getWeatherForDay(lat, lng, dayIndex);
                    if (weatherData) {
                        let iconClass = "fa-cloud";
                        if (weatherData.description.includes("Clear") || weatherData.description.includes("Sunny")) iconClass = "fa-sun text-yellow-500";
                        else if (weatherData.description.includes("Rain")) iconClass = "fa-umbrella text-blue-500";
                        
                        const suggestion = window.getClothingSuggestion(weatherData.temp, weatherData.description);
                        
                        let dateBadge = `<span class="text-xs font-bold text-orange-500 bg-orange-50 px-2 py-1 rounded">${displayDate}</span>`;
                        let refBadge = "";
                        if (weatherData.isReference) {
                            refBadge = `<div class="text-[10px] text-slate-400 mt-1"><i class="fa-solid fa-circle-info"></i> ç„¡é å ±è³‡æ–™ (åƒè€ƒç•¶åœ°ç›®å‰å¤©æ°£)</div>`;
                        }

                        item.innerHTML = `
                            <div class="flex flex-col mb-2">
                                <div class="flex justify-between items-center">
                                    ${dateBadge}
                                    <span class="text-xs text-slate-400"><i class="fa-solid fa-location-dot"></i> ${weatherData.locationName}</span>
                                </div>
                                ${refBadge}
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid ${iconClass} text-2xl"></i>
                                    <div>
                                        <div class="text-lg font-bold text-slate-800">${weatherData.temp}Â°C</div>
                                        <div class="text-xs text-slate-500">${weatherData.description}</div>
                                    </div>
                                </div>
                                <div class="text-right text-xs text-slate-500">
                                    <div>æ¿•åº¦ ${weatherData.humidity}%</div>
                                    <div>é™æ°´ ${weatherData.precipitation.toFixed(1)}mm</div>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-orange-600 bg-orange-50 p-2 rounded">${suggestion}</div>
                        `;
                    } else {
                        item.innerHTML = `<div class="flex justify-between"><span class="text-xs font-bold text-orange-500">${displayDate}</span><span class="text-xs text-slate-400">ç„¡é å ±è³‡æ–™</span></div>`;
                    }
                } else {
                     item.innerHTML = `<div class="flex justify-between"><span class="text-xs font-bold text-orange-500">${displayDate}</span><span class="text-xs text-slate-400">ç„¡åœ°é»è³‡æ–™</span></div>`;
                }
                list.appendChild(item);
                dayIndex++;
            }
            document.getElementById('weatherModal').classList.remove('hidden');
        };

        function getDisplayDate(dayIndex) {
            if (!window.currentMetaData || !window.currentMetaData.startDate) return `Day ${dayIndex}`;
            const start = new Date(window.currentMetaData.startDate);
            const current = new Date(start);
            current.setDate(start.getDate() + (parseInt(dayIndex) - 1));
            return `Day ${dayIndex} (${current.getMonth()+1}/${current.getDate()})`;
        }

        function renderTabs() {
            const container = document.getElementById('dayTabsContainer'); container.innerHTML = '';
            
            const summaryBtn = document.createElement('button');
            summaryBtn.className = `day-btn flex-1 min-w-[70px] py-2 rounded-lg text-center transition-all text-xs font-bold ${currentDay == 'summary' ? 'bg-sky-500 text-white shadow-md' : 'bg-slate-100 text-slate-600'}`;
            summaryBtn.dataset.day = 'summary';
            summaryBtn.onclick = () => switchDay('summary');
            summaryBtn.innerHTML = `<i class="fa-solid fa-chart-pie mb-1"></i><br><span class="text-[12px]">ç¸½è¦½èˆ‡é ç®—</span>`;
            container.appendChild(summaryBtn);

            Object.keys(window.currentItineraryData).forEach(day => {
                const btn = document.createElement('button');
                btn.className = `day-btn flex-1 min-w-[70px] py-2 rounded-lg text-center transition-all text-xs font-bold ${day == currentDay ? 'bg-sky-500 text-white shadow-md' : 'bg-slate-100 text-slate-600'}`;
                btn.dataset.day = day; btn.onclick = () => switchDay(day);
                // Modified: Add location to Day tab
                const locationText = window.currentMetaData.main_location ? window.currentMetaData.main_location.split(',')[1] || window.currentMetaData.main_location : (window.currentMetaData.country || 'è¡Œç¨‹');
                btn.innerHTML = `${getDisplayDate(day)}<br><span class="font-normal opacity-80 text-[10px] truncate block px-1">${locationText}</span>`;
                container.appendChild(btn);
            });
            const tipsBtn = document.createElement('button');
            tipsBtn.className = "day-btn flex-1 min-w-[70px] py-2 rounded-lg text-center transition-all bg-yellow-50 text-yellow-700 hover:bg-yellow-100 text-xs font-bold border border-yellow-200";
            tipsBtn.onclick = () => renderTips(); tipsBtn.innerHTML = `<i class="fa-regular fa-lightbulb text-lg mb-1"></i><br><span class="text-[12px]">AI æç¤º</span>`;
            container.appendChild(tipsBtn);
        }

        function switchDay(day) {
            currentDay = day;
            document.querySelectorAll('.day-btn').forEach(btn => {
                const isSummary = btn.innerHTML.includes('ç¸½è¦½');
                const isTips = btn.innerHTML.includes('AI æç¤º');
                
                if (btn.dataset.day == day) btn.className = "day-btn flex-1 min-w-[70px] py-2 rounded-lg text-center transition-all text-xs font-bold bg-sky-500 text-white shadow-md";
                else if(isTips) btn.className = "day-btn flex-1 min-w-[70px] py-2 rounded-lg text-center transition-all bg-yellow-50 text-yellow-700 hover:bg-yellow-100 text-xs font-bold border border-yellow-200";
                else btn.className = "day-btn flex-1 min-w-[70px] py-2 rounded-lg text-center transition-all text-xs font-bold bg-slate-100 text-slate-600";
            });
            
            const container = document.getElementById('contentList'); container.innerHTML = '';
            // Updated: Use LayerGroup to clear layers
            if (markersLayer) markersLayer.clearLayers();
            if (currentPolyline) { map.removeLayer(currentPolyline); currentPolyline = null; }
            
            if (day === 'summary') {
                renderSummaryView(container);
                return;
            }

            // Daily View
            const dayData = window.currentItineraryData[day]; if (!dayData) return;
            const header = document.createElement('div'); header.className = "mb-4";
            header.innerHTML = `<div class="flex items-center flex-wrap gap-y-1"><h2 id="dayTitle" data-editable class="text-xl font-bold text-sky-900 mr-2 outline-none rounded px-1 -ml-1 border border-transparent transition-all">${dayData.title}</h2></div><p id="dayDesc" data-editable class="text-sm text-slate-500 mt-1 outline-none rounded px-1 -ml-1 border border-transparent transition-all">${dayData.desc}</p>`;
            container.appendChild(header);
            
            const bounds = []; const routeCoords = [];
            dayData.stops.forEach((stop, index) => {
                const isLast = index === dayData.stops.length - 1;
                const lat = parseFloat(stop.lat); const lng = parseFloat(stop.lng);
                if (!isNaN(lat) && !isNaN(lng)) routeCoords.push([lat, lng]);
                const card = document.createElement('div');
                card.className = "card-hover bg-white rounded-xl p-4 border border-slate-200 cursor-pointer transition-all relative overflow-hidden group";
                card.onclick = () => { if(isEditMode) return; focusLocation(lat, lng); };
                let transportHtml = '';
                if (stop.transport) {
                   const trans = typeof stop.transport === 'string' ? stop.transport : stop.transport.desc;
                   transportHtml = `<div class="mt-2 text-xs bg-sky-50 p-1 rounded text-sky-600"><i class="fa-solid fa-train"></i> <span id="stop-trans-desc-${stop.id}" data-editable>${trans}</span></div>`;
                }
                // Modified: Added Location Badge inside card
                const locationBadge = `<div class="text-[10px] text-slate-400 mb-1 flex items-center gap-1"><i class="fa-solid fa-location-dot text-sky-400"></i> ${window.currentMetaData.main_location || window.currentMetaData.country || 'æ™¯é»'}</div>`;
                
                card.innerHTML = `<div class="relative"><div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-20">${index > 0 ? `<button onclick="window.moveStopUp(${day}, ${index}); event.stopPropagation();" class="bg-blue-500 hover:bg-blue-600 text-white p-1.5 rounded text-xs" title="ä¸Šç§»"><i class="fa-solid fa-arrow-up"></i></button>` : ''}${index < dayData.stops.length - 1 ? `<button onclick="window.moveStopDown(${day}, ${index}); event.stopPropagation();" class="bg-blue-500 hover:bg-blue-600 text-white p-1.5 rounded text-xs" title="ä¸‹ç§»"><i class="fa-solid fa-arrow-down"></i></button>` : ''}<button onclick="window.deleteStop(${day}, ${index}); event.stopPropagation();" class="bg-red-500 hover:bg-red-600 text-white p-1.5 rounded text-xs" title="åˆªé™¤"><i class="fa-solid fa-trash"></i></button></div><div class="flex gap-4"><div class="flex flex-col items-center"><div class="w-10 h-10 rounded-full bg-sky-50 text-sky-600 flex items-center justify-center shrink-0 border border-sky-100 group-hover:bg-sky-500 group-hover:text-white transition-colors z-10"><i class="fa-solid ${stop.icon || 'fa-map-pin'}"></i></div>${!isLast ? '<div class="w-0.5 h-full bg-slate-100 my-1"></div>' : ''}</div><div class="flex-1 pb-2"><div class="flex justify-between items-start mb-1"><span class="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">${stop.time}</span><div class="flex gap-1">${(stop.tags || []).map(t => `<span class="text-[10px] text-sky-500 bg-sky-50 px-1.5 rounded">${t}</span>`).join('')}</div></div>${locationBadge}<h3 class="text-lg font-bold text-slate-800 mb-1 group-hover:text-sky-600 outline-none rounded px-1 -ml-1 border border-transparent transition-all" id="stop-name-${stop.id}" data-editable>${stop.name}</h3><p class="text-sm text-slate-600 leading-relaxed outline-none rounded px-1 -ml-1 border border-transparent transition-all" id="stop-desc-${stop.id}" data-editable>${stop.desc}</p>${transportHtml}<div class="mt-2 text-xs flex gap-2"><button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stop.name)}&query_place_id=${lat},${lng}', '_blank'); event.stopPropagation();" class="bg-slate-100 hover:bg-green-100 text-slate-600 hover:text-green-700 px-2 py-1 rounded transition-colors"><i class="fa-solid fa-location-arrow"></i> å°èˆª</button></div></div></div></div>`;
                container.appendChild(card);
                if (!isNaN(lat) && !isNaN(lng)) {
                    const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-pin"></div><i class="fa-solid ${stop.icon || 'fa-map-pin'}"></i>`, iconSize: [30, 42], iconAnchor: [15, 42] });
                    // Updated: Add to markersLayer
                    const marker = L.marker([lat, lng], { icon: icon }).addTo(markersLayer).bindPopup(stop.name);
                    marker.on('click', () => focusLocation(lat, lng));
                    // Removed: markers[stop.id || Math.random()] = marker;
                    bounds.push([lat, lng]);
                }
            });
            if (routeCoords.length > 1) currentPolyline = L.polyline(routeCoords, { color: '#0ea5e9', weight: 3, opacity: 0.8, dashArray: '8, 8' }).addTo(map);
            if (bounds.length > 0) {
                currentBounds = bounds;
                setTimeout(() => { map.invalidateSize(); if(map.getContainer().offsetWidth > 0) map.fitBounds(bounds, { padding: [50, 50], animate: true }); }, 200); 
            }
            if(isEditMode) updateEditUI();
        }
        
        // Summary & Cost Analysis
        function renderSummaryView(container) {
            if (!window.currentItineraryData) {
                container.innerHTML = '<div class="p-4 text-center text-slate-400">å°šç„¡è¡Œç¨‹è³‡æ–™</div>';
                return;
            }

            const header = document.createElement('div'); header.className = "mb-4";
            header.innerHTML = `<div class="flex items-center gap-2"><h2 class="text-2xl font-bold text-sky-900">ğŸ—“ï¸ è¡Œç¨‹ç¸½è¦½</h2></div><p class="text-sm text-slate-500 mt-1">å…¨åœ°åœ–æª¢è¦–æ¨¡å¼</p>`;
            container.appendChild(header);

            // Safe Access Logic for Metadata
            const meta = window.currentMetaData || {};
            const defaultCosts = { total: 0, accommodation: 0, transport: 0, food: 0, currency: 'TWD' };
            
            // Merge defaults to prevent undefined crashes
            const costs = { ...defaultCosts, ...(meta.estimated_costs || {}) };

            const costDiv = document.createElement('div');
            costDiv.className = "bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-4";
            
            // Logic for zero costs
            const hasCosts = (costs.total > 0);
            const chartHtml = hasCosts ? `<canvas id="costChart"></canvas>` : `<div class="w-full h-full flex items-center justify-center bg-slate-50 rounded-full text-xs text-slate-400 text-center px-1">æš«ç„¡æ•¸æ“š</div>`;

            // Use safe number formatting (0 if undefined/null)
            const fmt = (num) => (num || 0).toLocaleString();

            costDiv.innerHTML = `
                <h3 class="font-bold text-sky-800 mb-3"><i class="fa-solid fa-wallet mr-2"></i>é ç®—åˆ†æ (ä¼°ç®—)</h3>
                <div class="flex gap-4 items-center">
                    <div class="w-1/3 relative" style="height:100px; width:100px;">
                        ${chartHtml}
                    </div>
                    <div class="flex-1 space-y-2 text-sm">
                        <div class="flex justify-between border-b border-slate-50 pb-1"><span>ğŸ  ä½å®¿</span> <span class="font-bold">${fmt(costs.accommodation)} ${costs.currency}</span></div>
                        <div class="flex justify-between border-b border-slate-50 pb-1"><span>ğŸš† äº¤é€š</span> <span class="font-bold">${fmt(costs.transport)} ${costs.currency}</span></div>
                        <div class="flex justify-between border-b border-slate-50 pb-1"><span>ğŸ± é¤é£²</span> <span class="font-bold">${fmt(costs.food)} ${costs.currency}</span></div>
                        <div class="flex justify-between pt-1 text-sky-600 text-base"><span>ğŸ’° ç¸½è¨ˆ</span> <span class="font-bold">${fmt(costs.total)} ${costs.currency}</span></div>
                    </div>
                </div>
            `;
            container.appendChild(costDiv);
            
            // Draw Chart only if data exists and canvas is present
            if (hasCosts) {
                setTimeout(() => {
                    const canvas = document.getElementById('costChart');
                    if (!canvas) return; // Prevent crash if switched away
                    
                    const ctx = canvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['ä½å®¿', 'äº¤é€š', 'é¤é£²'],
                            datasets: [{
                                data: [costs.accommodation, costs.transport, costs.food],
                                backgroundColor: ['#f472b6', '#3b82f6', '#f59e0b'],
                                borderWidth: 0
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });
                }, 100);
            }

            // Itinerary List
            const bounds = [];
            const allRouteCoords = [];
            let globalStopIndex = 1;

            if (window.currentItineraryData) {
                Object.keys(window.currentItineraryData).forEach(dayKey => {
                    const dayData = window.currentItineraryData[dayKey];
                    if(!dayData) return;

                    const dayHeader = document.createElement('div');
                    dayHeader.className = "sticky top-0 bg-sky-50/90 backdrop-blur px-3 py-2 rounded-lg font-bold text-sky-800 text-sm border border-sky-100 z-10 mb-2 shadow-sm";
                    dayHeader.innerHTML = `${getDisplayDate(dayKey)} - ${dayData.title}`;
                    container.appendChild(dayHeader);

                    if (dayData.stops) {
                        dayData.stops.forEach((stop) => {
                            const lat = parseFloat(stop.lat); const lng = parseFloat(stop.lng);
                            if (!isNaN(lat) && !isNaN(lng)) {
                                allRouteCoords.push([lat, lng]); bounds.push([lat, lng]);
                                const item = document.createElement('div');
                                item.className = "flex items-center gap-3 p-3 bg-white rounded-lg border border-slate-100 mb-2";
                                // Modified: Added Location Badge inside summary list item
                                const locationText = (meta.main_location) || (meta.country) || 'æ™¯é»';
                                item.innerHTML = `
                                    <div class="w-6 h-6 rounded-full bg-sky-500 text-white flex items-center justify-center text-xs font-bold shadow-sm shrink-0">${globalStopIndex}</div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-bold text-slate-800 text-sm truncate">${stop.name}</div>
                                        <div class="text-[10px] text-slate-400 mt-0.5"><i class="fa-solid fa-location-dot text-sky-400"></i> ${locationText}</div>
                                    </div>
                                `;
                                item.onclick = () => { switchDay(dayKey); focusLocation(lat, lng); };
                                container.appendChild(item);

                                const numberIcon = L.divIcon({ className: 'custom-number-icon', html: `<div class="number-icon">${globalStopIndex}</div>`, iconSize: [30, 30], iconAnchor: [15, 15] });
                                // Updated: Add to markersLayer
                                const marker = L.marker([lat, lng], { icon: numberIcon }).addTo(markersLayer).bindPopup(`<b>${globalStopIndex}. ${stop.name}</b>`);
                                marker.on('click', () => focusLocation(lat, lng));
                                // Removed: markers[stop.id || Math.random()] = marker;
                                globalStopIndex++;
                            }
                        });
                    }
                });
            }

            if (allRouteCoords.length > 1) {
                currentPolyline = L.polyline(allRouteCoords, { color: '#0ea5e9', weight: 3, opacity: 0.8, dashArray: '6, 6' }).addTo(map);
            }
            if (bounds.length > 0) {
                currentBounds = bounds;
                setTimeout(() => { map.invalidateSize(); if(map.getContainer().offsetWidth > 0) map.fitBounds(bounds, { padding: [50, 50] }); }, 200);
            }
        }

        // Pure AI Tips - No Lookup Table
        async function renderTips() {
            const container = document.getElementById('contentList');
            container.innerHTML = '<div class="p-4 text-center"><div class="loader mx-auto mb-3"></div><p class="text-slate-500">AI æ­£åœ¨åˆ†æè¡Œç¨‹åœ°é»ä¸¦ç”Ÿæˆå°ˆå±¬å»ºè­°...</p></div>';
            
            const apiKey = window.safeStorage.getItem('gemini_api_key');
            if (!apiKey) {
                container.innerHTML = `<div class="p-4 text-center"><p class="text-slate-500">è«‹å…ˆé€£çµ AI ä»¥ç²å–å³æ™‚åˆ†ææç¤ºã€‚</p><button onclick="openSettingsModal()" class="mt-2 text-sky-500 font-bold">å‰å¾€è¨­å®š</button></div>`;
                return;
            }

            // Extract all unique locations
            const locations = new Set();
            Object.values(window.currentItineraryData).forEach(day => {
                day.stops.forEach(stop => locations.add(stop.name));
            });
            const locationList = Array.from(locations).join(', ');
            const country = window.currentMetaData.country || "è©²åœ‹å®¶";

            const prompt = `
            æˆ‘æ˜¯æ—…å®¢ï¼Œå³å°‡å‰å¾€ ${country}ï¼Œæœƒé€ è¨ªä»¥ä¸‹åœ°é»ï¼š${locationList}ã€‚
            è«‹æ ¹æ“šé€™äº›ã€Œå…·é«”åœ°é»ã€æä¾›æ—…éŠè²¼å£«ã€‚
            
            STRICT RULES:
            1. DO NOT give generic advice. Be specific to the locations.
            2. Output ONLY JSON format.
            3. JSON schema:
            {
              "country": "${country}",
              "safety": "é‡å°ä¸Šè¿°åœ°é»çš„æ²»å®‰å»ºè­° (100å­—)",
              "health": "ç•¶åœ°çš„å¸¸è¦‹ç–¾ç—…ã€å¿…è¦çš„ç–«è‹—æ¥ç¨®å»ºè­°ã€è¡›ç”Ÿæ³¨æ„äº‹é …ç­‰ (100å­—)",
              "customs": "ç•¶åœ°é‡è¦é¢¨ä¿—ç¦å¿Œ (100å­—)",
              "transport_tips": "äº¤é€šæ³¨æ„äº‹é … (100å­—)",
              "tipping_tax": "å°è²»èˆ‡é€€ç¨…è¦å‰‡ (50å­—)",
              "specific_advice": "é‡å° ${locationList} çš„ç‰¹åˆ¥å»ºè­° (150å­—)"
            }
            `;

            // Retry Loop Logic
            const maxRetries = 3;
            let lastError = null;

            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    // Handle 429 Quota Exceeded
                    if (response.status === 429) {
                        const retryAfter = 5000 * Math.pow(2, attempt); 
                        console.warn(`Quota exceeded (429). Retrying in ${retryAfter}ms...`);
                        if (attempt < maxRetries) {
                            container.innerHTML = `<div class="p-4 text-center"><div class="loader mx-auto mb-3"></div><p class="text-orange-500">API ä½¿ç”¨é‡å¤§ï¼Œæ­£åœ¨æ’éšŠé‡è©¦ä¸­... (${attempt + 1}/${maxRetries})</p></div>`;
                            await new Promise(r => setTimeout(r, retryAfter));
                            continue;
                        } else {
                            throw new Error("API é…é¡å·²æ»¿ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                        }
                    }

                    const data = await response.json();
                    
                    if (data.error) {
                        // Check specifically for quota error in body if status wasn't 429
                        if (data.error.code === 429 || (data.error.message && data.error.message.includes('quota'))) {
                             const retryAfter = 5000 * Math.pow(2, attempt);
                             console.warn(`Quota error in body. Retrying in ${retryAfter}ms...`);
                             if (attempt < maxRetries) {
                                container.innerHTML = `<div class="p-4 text-center"><div class="loader mx-auto mb-3"></div><p class="text-orange-500">API ä½¿ç”¨é‡å¤§ï¼Œæ­£åœ¨æ’éšŠé‡è©¦ä¸­... (${attempt + 1}/${maxRetries})</p></div>`;
                                await new Promise(r => setTimeout(r, retryAfter));
                                continue;
                             } else {
                                throw new Error("API é…é¡å·²æ»¿ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                             }
                        }
                        throw new Error(data.error.message);
                    }

                    if (!data.candidates || data.candidates.length === 0) {
                        throw new Error("AI æœªå›å‚³ä»»ä½•å»ºè­° (å¯èƒ½è¢«å®‰å…¨è¨­å®šé˜»æ“‹)");
                    }
                    
                    const part = data.candidates[0].content?.parts?.[0];
                    if (!part || !part.text) {
                        throw new Error("AI å›å‚³æ ¼å¼éŒ¯èª¤");
                    }
                    
                    const text = part.text;
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error("ç„¡æ³•è§£æ JSON");
                    const tips = JSON.parse(jsonMatch[0]);
                    
                    container.innerHTML = `
                        <div class="p-4 space-y-4">
                            <div class="flex items-center gap-2"><h2 class="text-2xl font-bold text-sky-900">ğŸ’¡ ${tips.country} æ—…éŠæç¤º</h2><span class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded">AI ç”Ÿæˆ</span></div>
                            <div class="bg-amber-50 p-4 rounded-lg border border-amber-100"><h4 class="font-bold text-amber-800 mb-1">ğŸ›¡ï¸ æ²»å®‰</h4><p class="text-sm text-amber-900">${tips.safety}</p></div>
                            <div class="bg-red-50 p-4 rounded-lg border border-red-100"><h4 class="font-bold text-red-800 mb-1">ğŸ¥ å¥åº·èˆ‡é†«ç™‚</h4><p class="text-sm text-red-900">${tips.health}</p></div>
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100"><h4 class="font-bold text-blue-800 mb-1">ğŸ¤ é¢¨ä¿—</h4><p class="text-sm text-blue-900">${tips.customs}</p></div>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-100"><h4 class="font-bold text-green-800 mb-1">ğŸš† äº¤é€š</h4><p class="text-sm text-green-900">${tips.transport_tips}</p></div>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-100"><h4 class="font-bold text-gray-800 mb-1">ğŸ’° ç¨…å‹™èˆ‡å°è²»</h4><p class="text-sm text-gray-900">${tips.tipping_tax}</p></div>
                            <div class="bg-sky-50 p-4 rounded-lg border border-sky-100"><h4 class="font-bold text-sky-800 mb-1">âœ¨ å°ˆå±¬å»ºè­°</h4><p class="text-sm text-sky-900">${tips.specific_advice}</p></div>
                        </div>
                    `;
                    return; // Success exit

                } catch (e) {
                    console.error(`Attempt ${attempt + 1} failed:`, e);
                    lastError = e;
                    if (attempt < maxRetries && !e.message.includes('quota')) { 
                         // Backoff for other non-quota errors (e.g. network blip)
                         await new Promise(r => setTimeout(r, 2000));
                    }
                }
            }

            // Final Error Display
            container.innerHTML = `<div class="p-4 text-center text-red-500">
                <i class="fa-solid fa-circle-exclamation text-2xl mb-2"></i><br>
                åˆ†æå¤±æ•—<br>
                <span class="text-xs text-slate-400">${lastError ? lastError.message : 'æœªçŸ¥éŒ¯èª¤'}</span>
            </div>`;
        }
        
        function focusLocation(lat, lng) {
            map.invalidateSize(); 
            if (map.getContainer().offsetWidth > 0) map.flyTo([lat, lng], 16, { duration: 1 });
        }
        
        window.searchMapLocation = async () => {
            const query = document.getElementById('mapSearchInput').value.trim();
            if (!query) return window.showToast("è«‹è¼¸å…¥æœå°‹åœ°é»");
            const resultsDiv = document.getElementById('mapSearchResults');
            resultsDiv.innerHTML = '<div class="p-3 text-center text-slate-500 text-sm">æœå°‹ä¸­...</div>'; resultsDiv.classList.remove('hidden');
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                const results = await response.json();
                if (results.length === 0) { resultsDiv.innerHTML = '<div class="p-3 text-center text-slate-400 text-sm">ç„¡çµæœ</div>'; return; }
                resultsDiv.innerHTML = '';
                results.forEach(result => {
                    const item = document.createElement('div');
                    item.className = "p-3 border-b border-slate-100 hover:bg-sky-50 cursor-pointer text-sm font-bold text-slate-700";
                    item.innerText = result.display_name.split(',')[0];
                    item.onclick = () => {
                        const lat = parseFloat(result.lat); const lng = parseFloat(result.lon);
                        focusLocation(lat, lng); resultsDiv.classList.add('hidden');
                        showAddToItineraryPrompt(result.display_name.split(',')[0], lat, lng);
                    };
                    resultsDiv.appendChild(item);
                });
            } catch (err) { resultsDiv.innerHTML = '<div class="p-3 text-center text-red-500 text-sm">éŒ¯èª¤</div>'; }
        };

        window.showAddToItineraryPrompt = (placeName, lat, lng) => {
            const container = document.getElementById('contentList');
            const promptDiv = document.createElement('div');
            promptDiv.className = "bg-gradient-to-r from-sky-50 to-blue-50 border-2 border-sky-300 rounded-xl p-4 mb-4 sticky top-0 z-20 shadow-md";
            promptDiv.innerHTML = `
                <div class="flex items-center gap-3 mb-3"><i class="fa-solid fa-location-dot text-sky-600 text-xl"></i><div class="flex-1"><div class="font-bold text-slate-800">${placeName}</div><div class="text-xs text-slate-500">åº§æ¨™: ${lat.toFixed(4)}, ${lng.toFixed(4)}</div></div></div>
                <div class="flex gap-2"><select id="addToDaySelect" class="flex-1 px-3 py-2 border border-sky-200 rounded-lg text-sm outline-none">${Object.keys(window.currentItineraryData).map(day => `<option value="${day}">ç¬¬ ${day} å¤©</option>`).join('')}</select><button onclick="window.confirmAddToItinerary('${placeName}', ${lat}, ${lng})" class="bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded-lg font-bold text-sm"><i class="fa-solid fa-plus"></i> åŠ å…¥</button><button onclick="this.closest('.sticky').remove()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-2 rounded-lg text-sm"><i class="fa-solid fa-times"></i></button></div>
            `;
            container.prepend(promptDiv);
        };
        
        window.confirmAddToItinerary = (placeName, lat, lng) => {
            const day = document.getElementById('addToDaySelect').value;
            window.currentItineraryData[day].stops.push({ id: Date.now(), time: "å¾…å®š", name: placeName, lat: lat, lng: lng, icon: "fa-map-pin", desc: "åœ¨åœ°åœ–ä¸Šæœå°‹çš„åœ°é»", tags: ["æ–°å¢"] });
            window.saveCurrentItinerary(); window.showToast("å·²åŠ å…¥è¡Œç¨‹ï¼"); switchDay(day);
            if(window.innerWidth < 768) toggleMobileView('list');
        };

        window.moveStopUp = (day, index) => { if(index <= 0) return; const stops = window.currentItineraryData[day].stops; [stops[index - 1], stops[index]] = [stops[index], stops[index - 1]]; switchDay(day); window.saveCurrentItinerary(); };
        window.moveStopDown = (day, index) => { const stops = window.currentItineraryData[day].stops; if(index >= stops.length - 1) return; [stops[index], stops[index + 1]] = [stops[index + 1], stops[index]]; switchDay(day); window.saveCurrentItinerary(); };
        window.deleteStop = (day, index) => { if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return; window.currentItineraryData[day].stops.splice(index, 1); switchDay(day); window.saveCurrentItinerary(); };
        window.openFlightSearch = () => { window.open('https://flight.sabretn.com.tw/newdefault', '_blank'); };
        
        window.toggleMobileView = (view) => {
            const list = document.getElementById('itineraryPanel'); const mapEl = document.getElementById('mapPanel');
            const navList = document.getElementById('nav-list'); const navMap = document.getElementById('nav-map');
            if(view === 'list') { list.classList.add('active'); mapEl.classList.remove('active'); navList.classList.replace('text-slate-400', 'text-sky-600'); navMap.classList.replace('text-sky-600', 'text-slate-400'); }
            else { list.classList.remove('active'); mapEl.classList.add('active'); navMap.classList.replace('text-slate-400', 'text-sky-600'); navList.classList.replace('text-sky-600', 'text-slate-400'); setTimeout(() => { map.invalidateSize(); if(currentBounds) map.fitBounds(currentBounds, {padding:[50,50]}); }, 100); }
        };

        window.handleGenerateClick = async () => {
            const prompt = document.getElementById('aiPromptInput').value;
            const startDate = document.getElementById('aiStartDate').value;
            const apiKey = window.safeStorage.getItem('gemini_api_key') || envApiKey;
            
            if(!prompt.trim()) return alert("è«‹è¼¸å…¥éœ€æ±‚");
            if (!apiKey) return window.useDemoMode();

            const btn = document.getElementById('generateBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="loader w-4 h-4 border-2 border-white border-t-transparent"></div>`; btn.disabled = true;
            document.getElementById('aiErrorMsg').classList.add('hidden');

            const systemPrompt = `
            You are a Worldwide Travel Guide API. Generate a travel itinerary JSON.
            STRICT RULES:
            1. Return ONLY valid JSON.
            2. Schema:
               {
                 "meta": { 
                    "country": "Main Country (e.g. Japan)",
                    "main_location": "Country, City (e.g. Japan, Kyoto)",
                    "currency": "1 TWD â‰ˆ X.X LOC", 
                    "estimated_costs": { "accommodation": 0, "transport": 0, "food": 0, "total": 0, "currency": "LOC" }
                 },
                 "days": {
                    "1": { 
                       "title": "Day Title", "weather": "Forecast", "desc": "Description", 
                       "stops": [ { 
                           "id": 1, "time": "Morning", "name": "Place Name", "lat": 35.0, "lng": 135.0, "icon": "fa-landmark", "desc": "Short Desc", 
                           "transport": { "mode": "Bus", "desc": "Details", "price": "100" }, 
                           "tags": ["Tag"] 
                       } ] 
                    }
                 }
               }
            3. "estimated_costs" is MANDATORY. Estimate realistic costs for the whole trip in local currency.
            4. "main_location" MUST be "Country, City" format.
            5. Coordinates must be real.
            6. Language: Traditional Chinese.
            `;

            // Retry Loop Logic for Generate Itinerary
            const maxRetries = 3;
            let lastError = null;

            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    // Handle 429 Quota Exceeded
                    if (response.status === 429) {
                        const retryAfter = 5000 * Math.pow(2, attempt); 
                        console.warn(`Quota exceeded (429). Retrying in ${retryAfter}ms...`);
                        if (attempt < maxRetries) {
                            btn.innerHTML = `<span class="text-xs">APIå¿™ç·šä¸­...é‡è©¦(${attempt + 1})</span>`;
                            await new Promise(r => setTimeout(r, retryAfter));
                            continue;
                        } else {
                            throw new Error("API é…é¡å·²æ»¿ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                        }
                    }

                    const data = await response.json();
                    
                    if (data.error) {
                        // Check specifically for quota error in body if status wasn't 429
                        if (data.error.code === 429 || (data.error.message && data.error.message.includes('quota'))) {
                             const retryAfter = 5000 * Math.pow(2, attempt);
                             console.warn(`Quota error in body. Retrying in ${retryAfter}ms...`);
                             if (attempt < maxRetries) {
                                btn.innerHTML = `<span class="text-xs">APIå¿™ç·šä¸­...é‡è©¦(${attempt + 1})</span>`;
                                await new Promise(r => setTimeout(r, retryAfter));
                                continue;
                             } else {
                                throw new Error("API é…é¡å·²æ»¿ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                             }
                        }
                        throw new Error(data.error.message);
                    }

                    if (!data.candidates || data.candidates.length === 0) {
                        throw new Error("AI æœªå›å‚³ä»»ä½•å»ºè­° (å¯èƒ½è¢«å®‰å…¨è¨­å®šé˜»æ“‹)");
                    }
                    
                    const part = data.candidates[0].content?.parts?.[0];
                    if (!part || !part.text) {
                        throw new Error("AI å›å‚³æ ¼å¼éŒ¯èª¤");
                    }

                    const jsonText = part.text;
                    const result = JSON.parse(jsonText);
                    
                    result.meta.startDate = startDate;
                    window.loadItineraryFromHistory(result.days, result.meta, null);
                    window.closeModal('aiModal');
                    window.saveCurrentItinerary();
                    return; // Success exit

                } catch (e) {
                    console.error(`Attempt ${attempt + 1} failed:`, e);
                    lastError = e;
                    if (attempt < maxRetries && !e.message.includes('quota')) { 
                         // Backoff for other non-quota errors (e.g. network blip)
                         await new Promise(r => setTimeout(r, 2000));
                    }
                }
            }

            // Final Error Display
            console.error(lastError);
            const errorMsgEl = document.getElementById('aiErrorMsg');
            errorMsgEl.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> <span>${lastError ? lastError.message : 'ç™¼ç”ŸéŒ¯èª¤'}</span>`;
            errorMsgEl.classList.remove('hidden');
            btn.innerHTML = originalText; 
            btn.disabled = false;
        };

        window.runMockGeneration = () => {
             const btn = document.getElementById('generateBtn');
             const originalText = btn.innerHTML;
             btn.innerHTML = `<div class="loader w-4 h-4 border-2 border-white border-t-transparent"></div>`;
             setTimeout(() => {
                 alert("å·²è¼‰å…¥ç¯„ä¾‹ï¼");
                 btn.innerHTML = originalText;
                 window.closeModal('aiModal');
             }, 800);
        };
    </script>
</body>
</html>

















